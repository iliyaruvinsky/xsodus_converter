DROP VIEW SAPABAP1.CV_INVENTORY_ORDERS CASCADE;
CREATE VIEW SAPABAP1.CV_INVENTORY_ORDERS AS
WITH
  projection_7 AS (
    SELECT
        SAPABAP1."/BIC/AZEKKO2".EBELN AS EBELN_EKKO,
        SAPABAP1."/BIC/AZEKKO2".BSART AS BSART_EKKO,
        SAPABAP1."/BIC/AZEKKO2".BSTYP AS BSTYP_EKKO,
        SAPABAP1."/BIC/AZEKKO2".AEDAT AS AEDAT_EKKO,
        SAPABAP1."/BIC/AZEKKO2".LIFNR AS LIFNR_EKKO,
        SAPABAP1."/BIC/AZEKKO2".ERNAM AS ERNAM_EKKO,
        SAPABAP1."/BIC/AZEKKO2".EKORG AS EKORG_EKKO,
        SAPABAP1."/BIC/AZEKKO2".EKGRP AS EKGRP_EKKO,
        SAPABAP1."/BIC/AZEKKO2".BEDAT AS BEDAT_EKKO,
        SAPABAP1."/BIC/AZEKKO2".ZTERM AS ZTERM_EKKO,
        SAPABAP1."/BIC/AZEKKO2".WAERS AS WAERS,
        SAPABAP1."/BIC/AZEKKO2".WKURS AS WKURS_EKKO,
        SAPABAP1."/BIC/AZEKKO2".ZZNAME_CO AS ZZNAME_CO_EKKO
    FROM SAPABAP1."/BIC/AZEKKO2"
  ),
  projection_6 AS (
    SELECT
        SAPABAP1."/BIC/AZEKPO2".EBELN AS EBELN_EKPO,
        SAPABAP1."/BIC/AZEKPO2".EBELP AS EBELP_EKPO,
        SAPABAP1."/BIC/AZEKPO2".AEDAT AS AEDAT_EKPO,
        SAPABAP1."/BIC/AZEKPO2".TXZ01 AS TXZ01_EKPO,
        SAPABAP1."/BIC/AZEKPO2".MATNR AS MATNR_EKPO,
        SAPABAP1."/BIC/AZEKPO2".EMATN AS EMATN_EKPO,
        SAPABAP1."/BIC/AZEKPO2".WERKS AS WERKS_EKPO,
        SAPABAP1."/BIC/AZEKPO2".LGORT AS LGORT_EKPO,
        SAPABAP1."/BIC/AZEKPO2".BEDNR AS BEDNR_EKPO,
        SAPABAP1."/BIC/AZEKPO2".MATKL AS MATKL_EKPO,
        SAPABAP1."/BIC/AZEKPO2".KTMNG AS KTMNG_EKPO,
        SAPABAP1."/BIC/AZEKPO2".MENGE AS MENGE_EKPO,
        SAPABAP1."/BIC/AZEKPO2".MEINS AS MEINS_EKPO,
        SAPABAP1."/BIC/AZEKPO2".NETPR AS NETPR_EKPO,
        SAPABAP1."/BIC/AZEKPO2".PEINH AS PEINH_EKPO,
        SAPABAP1."/BIC/AZEKPO2".BRTWR AS BRTWR_EKPO,
        SAPABAP1."/BIC/AZEKPO2".KONNR AS KONNR_EKPO,
        SAPABAP1."/BIC/AZEKPO2".KTPNR AS KTPNR_EKPO,
        SAPABAP1."/BIC/AZEKPO2".EFFWR AS EFFWR_EKPO,
        SAPABAP1."/BIC/AZEKPO2".BANFN AS BANFN_EKPO,
        SAPABAP1."/BIC/AZEKPO2".BNFPO AS BNFPO_EKPO,
        SAPABAP1."/BIC/AZEKPO2".LOEKZ AS LOEKZ_EKPO,
        SAPABAP1."/BIC/AZEKPO2".PACKNO AS PACKNO_EKPO,
        SAPABAP1."/BIC/AZEKPO2".ELIKZ AS ELIKZ,
        SAPABAP1."/BIC/AZEKPO2".WERKS AS WERKS,
        SAPABAP1."/BIC/AZEKPO2".NETWR AS NETWR_EKPO,
        SAPABAP1."/BIC/AZEKPO2".WAERS AS WAERS_EKPO,
        SAPABAP1."/BIC/AZEKPO2".ZWERT AS ZWERT_EKPO,
        SAPABAP1."/BIC/AZEKPO2".NAVNW AS NAVNW_EKPO,
        SAPABAP1."/BIC/AZEKPO2".ABMNG AS ABMNG_EKPO,
        SAPABAP1."/BIC/AZEKPO2".NTGEW AS NTGEW_EKPO,
        SAPABAP1."/BIC/AZEKPO2".BRGEW AS BRGEW_EKPO,
        SAPABAP1."/BIC/AZEKPO2".VOLUM AS VOLUM_EKPO,
        SAPABAP1."/BIC/AZEKPO2".CQU_SAR AS CQU_SAR_EKPO,
        SAPABAP1."/BIC/AZEKPO2".GEWEI AS GEWEI_EKPO
    FROM SAPABAP1."/BIC/AZEKPO2"
    WHERE ("LOEKZ" ='')
  ),
  projection_8 AS (
    SELECT
        SAPABAP1."/BIC/AZEKET2".EINDT AS EINDT,
        SAPABAP1."/BIC/AZEKET2".EBELN AS EBELN,
        SAPABAP1."/BIC/AZEKET2".EBELP AS EBELP,
        SAPABAP1."/BIC/AZEKET2".MENGE AS MENGE,
        SAPABAP1."/BIC/AZEKET2".WEMNG AS WEMNG
    FROM SAPABAP1."/BIC/AZEKET2"
  ),
  join_6 AS (
    SELECT
        projection_6.AEDAT_EKPO AS AEDAT_EKPO,
        projection_6.TXZ01_EKPO AS TXZ01_EKPO,
        projection_6.EBELN_EKPO AS EBELN_EKPO,
        projection_6.EBELP_EKPO AS EBELP_EKPO,
        projection_6.MATNR_EKPO AS MATNR_EKPO,
        projection_6.EMATN_EKPO AS EMATN_EKPO,
        projection_6.WERKS_EKPO AS WERKS_EKPO,
        projection_6.LGORT_EKPO AS LGORT_EKPO,
        projection_6.BEDNR_EKPO AS BEDNR_EKPO,
        projection_6.MATKL_EKPO AS MATKL_EKPO,
        projection_6.KTMNG_EKPO AS KTMNG_EKPO,
        projection_6.MENGE_EKPO AS MENGE_EKPO,
        projection_6.MEINS_EKPO AS MEINS_EKPO,
        projection_6.NETPR_EKPO AS NETPR_EKPO,
        projection_6.PEINH_EKPO AS PEINH_EKPO,
        projection_6.BRTWR_EKPO AS BRTWR_EKPO,
        projection_6.KONNR_EKPO AS KONNR_EKPO,
        projection_6.KTPNR_EKPO AS KTPNR_EKPO,
        projection_6.EFFWR_EKPO AS EFFWR_EKPO,
        projection_6.BANFN_EKPO AS BANFN_EKPO,
        projection_6.BNFPO_EKPO AS BNFPO_EKPO,
        projection_6.PACKNO_EKPO AS PACKNO_EKPO,
        projection_6.NETWR_EKPO AS NETWR_EKPO,
        projection_6.WAERS_EKPO AS WAERS_EKPO,
        projection_6.ZWERT_EKPO AS ZWERT_EKPO,
        projection_6.NAVNW_EKPO AS NAVNW_EKPO,
        projection_6.ABMNG_EKPO AS ABMNG_EKPO,
        projection_6.NTGEW_EKPO AS NTGEW_EKPO,
        projection_6.BRGEW_EKPO AS BRGEW_EKPO,
        projection_6.VOLUM_EKPO AS VOLUM_EKPO,
        projection_6.CQU_SAR_EKPO AS CQU_SAR_EKPO,
        projection_6.GEWEI_EKPO AS GEWEI_EKPO,
        projection_8.EINDT AS EINDT,
        projection_8.WEMNG AS WEMNG,
        projection_8.MENGE AS MENGE
    FROM projection_6
    INNER JOIN projection_8 ON projection_6.EBELN_EKPO = projection_8.EBELN AND projection_6.EBELP_EKPO = projection_8.EBELP
  ),
  join_4 AS (
    SELECT
        projection_7.BSART_EKKO AS BSART_EKKO,
        projection_7.BSTYP_EKKO AS BSTYP_EKKO,
        projection_7.AEDAT_EKKO AS AEDAT_EKKO,
        projection_7.LIFNR_EKKO AS LIFNR_EKKO,
        projection_7.ERNAM_EKKO AS ERNAM_EKKO,
        projection_7.EKORG_EKKO AS EKORG_EKKO,
        projection_7.EKGRP_EKKO AS EKGRP_EKKO,
        projection_7.BEDAT_EKKO AS BEDAT_EKKO,
        projection_7.ZTERM_EKKO AS ZTERM_EKKO,
        projection_7.WAERS AS WAERS,
        projection_7.WKURS_EKKO AS WKURS_EKKO,
        projection_7.ZZNAME_CO_EKKO AS ZZNAMECO_EKKO,
        join_6.AEDAT_EKPO AS AEDAT_EKPO,
        join_6.TXZ01_EKPO AS TXZ01_EKPO,
        join_6.EBELN_EKPO AS EBELN_EKPO,
        join_6.EBELP_EKPO AS EBELP_EKPO,
        join_6.MATNR_EKPO AS MATNR_EKPO,
        join_6.EMATN_EKPO AS EMATN_EKPO,
        join_6.WERKS_EKPO AS WERKS_EKPO,
        join_6.LGORT_EKPO AS LGORT_EKPO,
        join_6.BEDNR_EKPO AS BEDNR_EKPO,
        join_6.MATKL_EKPO AS MATKL_EKPO,
        join_6.KTMNG_EKPO AS KTMNG_EKPO,
        join_6.MENGE_EKPO AS MENGE_EKPO,
        join_6.MEINS_EKPO AS MEINS_EKPO,
        join_6.NETPR_EKPO AS NETPR_EKPO,
        join_6.PEINH_EKPO AS PEINH_EKPO,
        join_6.BRTWR_EKPO AS BRTWR_EKPO,
        join_6.KONNR_EKPO AS KONNR_EKPO,
        join_6.KTPNR_EKPO AS KTPNR_EKPO,
        join_6.EFFWR_EKPO AS EFFWR_EKPO,
        join_6.BANFN_EKPO AS BANFN_EKPO,
        join_6.BNFPO_EKPO AS BNFPO_EKPO,
        join_6.PACKNO_EKPO AS PACKNO_EKPO,
        join_6.EINDT AS EINDT,
        join_6.WEMNG AS WEMNG,
        join_6.MENGE AS MENGE,
        join_6.NETWR_EKPO AS NETWR_EKPO,
        join_6.WAERS_EKPO AS WAERS_EKPO,
        join_6.ZWERT_EKPO AS ZWERT_EKPO,
        join_6.NAVNW_EKPO AS NAVNW_EKPO,
        join_6.ABMNG_EKPO AS ABMNG_EKPO,
        join_6.NTGEW_EKPO AS NTGEW_EKPO,
        join_6.BRGEW_EKPO AS BRGEW_EKPO,
        join_6.VOLUM_EKPO AS VOLUM_EKPO,
        join_6.CQU_SAR_EKPO AS CQU_SAR_EKPO,
        join_6.GEWEI_EKPO AS GEWEI_EKPO
    FROM projection_7
    INNER JOIN join_6 ON projection_7.EBELN_EKKO = join_6.EBELN_EKPO
  ),
  aggregation AS (
    SELECT
        agg_inner.*,
        SUBSTRING(agg_inner."AEDAT_EKKO", 1, 6) AS MONTH,
        SUBSTRING(agg_inner."AEDAT_EKKO", 1, 4) AS YEAR
    FROM (
      SELECT
          join_4.BSART_EKKO AS BSART_EKKO,
          join_4.BSTYP_EKKO AS BSTYP_EKKO,
          join_4.AEDAT_EKKO AS AEDAT_EKKO,
          join_4.LIFNR_EKKO AS LIFNR_EKKO,
          join_4.ERNAM_EKKO AS ERNAM_EKKO,
          join_4.EKORG_EKKO AS EKORG_EKKO,
          join_4.EKGRP_EKKO AS EKGRP_EKKO,
          join_4.BEDAT_EKKO AS BEDAT_EKKO,
          join_4.ZTERM_EKKO AS ZTERM_EKKO,
          join_4.WAERS AS WAERS_EKKO,
          join_4.ZZNAMECO_EKKO AS ZZNAMECO_EKKO,
          join_4.AEDAT_EKPO AS AEDAT_EKPO,
          join_4.TXZ01_EKPO AS TXZ01_EKPO,
          join_4.EBELN_EKPO AS EBELN_EKPO,
          join_4.EBELP_EKPO AS EBELP_EKPO,
          join_4.MATNR_EKPO AS MATNR_EKPO,
          join_4.EMATN_EKPO AS EMATN_EKPO,
          join_4.WERKS_EKPO AS WERKS_EKPO,
          join_4.LGORT_EKPO AS LGORT_EKPO,
          join_4.BEDNR_EKPO AS BEDNR_EKPO,
          join_4.MATKL_EKPO AS MATKL_EKPO,
          join_4.MEINS_EKPO AS MEINS_EKPO,
          join_4.KONNR_EKPO AS KONNR_EKPO,
          join_4.KTPNR_EKPO AS KTPNR_EKPO,
          join_4.BANFN_EKPO AS BANFN_EKPO,
          join_4.BNFPO_EKPO AS BNFPO_EKPO,
          join_4.PACKNO_EKPO AS PACKNO_EKPO,
          join_4.EINDT AS EINDT_EKET,
          join_4.WAERS_EKPO AS WAERS_EKPO,
          join_4.GEWEI_EKPO AS GEWEI_EKPO,
          SUM(join_4.WKURS_EKKO) AS WKURS_EKKO,
          SUM(join_4.KTMNG_EKPO) AS KTMNG_EKPO,
          SUM(join_4.MENGE_EKPO) AS MENGE_EKPO,
          SUM(join_4.NETPR_EKPO) AS NETPR_EKPO,
          SUM(join_4.PEINH_EKPO) AS PEINH_EKPO,
          SUM(join_4.BRTWR_EKPO) AS BRTWR_EKPO,
          SUM(join_4.EFFWR_EKPO) AS EFFWR_EKPO,
          SUM(join_4.WEMNG) AS WEMNG_EKET,
          SUM(join_4.MENGE) AS MENGE_EKET,
          SUM(join_4.NETWR_EKPO) AS NETWR_EKPO,
          SUM(join_4.ZWERT_EKPO) AS ZWERT_EKPO,
          SUM(join_4.NAVNW_EKPO) AS NAVNW_EKPO,
          SUM(join_4.ABMNG_EKPO) AS ABMNG_EKPO,
          SUM(join_4.NTGEW_EKPO) AS NTGEW_EKPO,
          SUM(join_4.BRGEW_EKPO) AS BRGEW_EKPO,
          SUM(join_4.VOLUM_EKPO) AS VOLUM_EKPO,
          SUM(join_4.CQU_SAR_EKPO) AS CQU_SAR_EKPO
      FROM join_4
      GROUP BY join_4.BSART_EKKO, join_4.BSTYP_EKKO, join_4.AEDAT_EKKO, join_4.LIFNR_EKKO, join_4.ERNAM_EKKO, join_4.EKORG_EKKO, join_4.EKGRP_EKKO, join_4.BEDAT_EKKO, join_4.ZTERM_EKKO, join_4.WAERS, join_4.ZZNAMECO_EKKO, join_4.AEDAT_EKPO, join_4.TXZ01_EKPO, join_4.EBELN_EKPO, join_4.EBELP_EKPO, join_4.MATNR_EKPO, join_4.EMATN_EKPO, join_4.WERKS_EKPO, join_4.LGORT_EKPO, join_4.BEDNR_EKPO, join_4.MATKL_EKPO, join_4.MEINS_EKPO, join_4.KONNR_EKPO, join_4.KTPNR_EKPO, join_4.BANFN_EKPO, join_4.BNFPO_EKPO, join_4.PACKNO_EKPO, join_4.EINDT, join_4.WAERS_EKPO, join_4.GEWEI_EKPO
    ) AS agg_inner
  )

SELECT MONTH, YEAR, BSART_EKKO, BSTYP_EKKO, AEDAT_EKKO, LIFNR_EKKO, ERNAM_EKKO, EKORG_EKKO, EKGRP_EKKO, BEDAT_EKKO, ZTERM_EKKO, WAERS_EKKO, WKURS_EKKO, ZZNAMECO_EKKO, AEDAT_EKPO, TXZ01_EKPO, EBELN_EKPO, EBELP_EKPO, MATNR_EKPO, EMATN_EKPO, WERKS_EKPO, LGORT_EKPO, BEDNR_EKPO, MATKL_EKPO, KTMNG_EKPO, MENGE_EKPO, MEINS_EKPO, NETPR_EKPO, PEINH_EKPO, BRTWR_EKPO, KONNR_EKPO, KTPNR_EKPO, EFFWR_EKPO, BANFN_EKPO, BNFPO_EKPO, PACKNO_EKPO, EINDT_EKET, WEMNG_EKET, MENGE_EKET, NETWR_EKPO, WAERS_EKPO, ZWERT_EKPO, NAVNW_EKPO, ABMNG_EKPO, NTGEW_EKPO, BRGEW_EKPO, VOLUM_EKPO, CQU_SAR_EKPO, GEWEI_EKPO FROM aggregation