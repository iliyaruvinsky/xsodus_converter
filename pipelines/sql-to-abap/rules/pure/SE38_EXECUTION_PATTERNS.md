# SE38 Execution Patterns

## Overview

This document defines standard patterns for running Pure ABAP extraction programs via transaction SE38. These patterns ensure consistent behavior across GUI and background execution modes.

**Purpose**: Provide standardized templates for selection screens, progress indication, error handling, and output generation.

---

## Program Structure Template

### Complete Report Structure
```abap
*&---------------------------------------------------------------------*
*& Report  Z_EXTRACT_[OBJECT_TYPE]
*&---------------------------------------------------------------------*
*& Purpose: Extract [description] to CSV
*& Author:  Generated by Xsodus SQL-to-ABAP Converter
*& Date:    [YYYYMMDD]
*&---------------------------------------------------------------------*
REPORT z_extract_[object_type] LINE-SIZE 255.

*----------------------------------------------------------------------*
* Type Definitions
*----------------------------------------------------------------------*
TYPES: BEGIN OF ty_output,
         field1 TYPE type1,
         field2 TYPE type2,
         " ... more fields
       END OF ty_output.

*----------------------------------------------------------------------*
* Data Declarations
*----------------------------------------------------------------------*
DATA: gt_output TYPE TABLE OF ty_output,
      gs_output TYPE ty_output,
      gt_csv    TYPE TABLE OF string,
      gv_line   TYPE string,
      gv_count  TYPE i.

*----------------------------------------------------------------------*
* Selection Screen
*----------------------------------------------------------------------*
SELECTION-SCREEN BEGIN OF BLOCK b1 WITH FRAME TITLE TEXT-001.
  PARAMETERS: p_path   TYPE string LOWER CASE DEFAULT 'C:\export.csv',
              p_gui    AS CHECKBOX DEFAULT 'X',
              p_head   AS CHECKBOX DEFAULT 'X',
              p_delim(1) TYPE c DEFAULT ';'.
SELECTION-SCREEN END OF BLOCK b1.

*----------------------------------------------------------------------*
* Initialization
*----------------------------------------------------------------------*
INITIALIZATION.
  TEXT-001 = 'Output Settings'.

*----------------------------------------------------------------------*
* Main Processing
*----------------------------------------------------------------------*
START-OF-SELECTION.
  PERFORM fetch_data.
  PERFORM export_csv.
  PERFORM display_results.

*&---------------------------------------------------------------------*
*& Form FETCH_DATA
*&---------------------------------------------------------------------*
FORM fetch_data.
  " Data extraction logic
ENDFORM.

*&---------------------------------------------------------------------*
*& Form EXPORT_CSV
*&---------------------------------------------------------------------*
FORM export_csv.
  " CSV generation and download
ENDFORM.

*&---------------------------------------------------------------------*
*& Form DISPLAY_RESULTS
*&---------------------------------------------------------------------*
FORM display_results.
  WRITE: / 'Extraction completed.'.
  WRITE: / 'Records:', gv_count.
  WRITE: / 'Output:', p_path.
ENDFORM.
```

---

## Selection Screen Patterns

### Basic Selection Screen
```abap
SELECTION-SCREEN BEGIN OF BLOCK b1 WITH FRAME TITLE TEXT-001.
  PARAMETERS: p_path   TYPE string LOWER CASE
              DEFAULT 'C:\temp\export.csv' OBLIGATORY,
              p_gui    AS CHECKBOX DEFAULT 'X',
              p_head   AS CHECKBOX DEFAULT 'X',
              p_delim(1) TYPE c DEFAULT ';'.
SELECTION-SCREEN END OF BLOCK b1.
```

### With Date Range Filter
```abap
SELECTION-SCREEN BEGIN OF BLOCK b2 WITH FRAME TITLE TEXT-002.
  SELECT-OPTIONS: s_date  FOR sy-datum DEFAULT sy-datum,
                  s_iobjnm FOR rsdiobj-iobjnm.
SELECTION-SCREEN END OF BLOCK b2.

INITIALIZATION.
  TEXT-001 = 'Output Settings'.
  TEXT-002 = 'Selection Criteria'.

  " Default: Last 30 days
  s_date-sign = 'I'.
  s_date-option = 'BT'.
  s_date-low = sy-datum - 30.
  s_date-high = sy-datum.
  APPEND s_date.
```

### With Radio Buttons for Mode
```abap
SELECTION-SCREEN BEGIN OF BLOCK b3 WITH FRAME TITLE TEXT-003.
  PARAMETERS: p_full   RADIOBUTTON GROUP rg1 DEFAULT 'X',
              p_delta  RADIOBUTTON GROUP rg1.
SELECTION-SCREEN END OF BLOCK b3.

INITIALIZATION.
  TEXT-003 = 'Extraction Mode'.
```

### Input Validation
```abap
AT SELECTION-SCREEN.
  " Validate path
  IF p_path IS INITIAL.
    MESSAGE e001(z_extract) WITH 'Output path is required'.
  ENDIF.

  " Validate date range
  IF s_date-high < s_date-low.
    MESSAGE e002(z_extract) WITH 'Invalid date range'.
  ENDIF.
```

---

## Progress Indicator

### Simple Progress
```abap
DATA: gv_total TYPE i,
      gv_current TYPE i,
      gv_percent TYPE i,
      gv_text TYPE string.

" Get total count
gv_total = lines( gt_data ).

LOOP AT gt_data INTO gs_data.
  gv_current = sy-tabix.
  gv_percent = ( gv_current * 100 ) / gv_total.
  gv_text = |Processing { gv_current } of { gv_total }|.

  CALL FUNCTION 'SAPGUI_PROGRESS_INDICATOR'
    EXPORTING
      percentage = gv_percent
      text       = gv_text.

  " Process record
  " ...
ENDLOOP.
```

### Stage-Based Progress
```abap
FORM show_progress USING pv_stage TYPE string
                         pv_percent TYPE i.
  DATA: lv_text TYPE string.
  lv_text = |{ pv_stage } ({ pv_percent }%)|.

  CALL FUNCTION 'SAPGUI_PROGRESS_INDICATOR'
    EXPORTING
      percentage = pv_percent
      text       = lv_text.
ENDFORM.

" Usage
PERFORM show_progress USING 'Fetching InfoObjects' 10.
" ... fetch logic
PERFORM show_progress USING 'Fetching Texts' 30.
" ... fetch logic
PERFORM show_progress USING 'Generating CSV' 70.
" ... export logic
PERFORM show_progress USING 'Complete' 100.
```

---

## Error Handling

### TRY-CATCH Pattern
```abap
TRY.
    " Database operation
    SELECT * FROM rsdiobj INTO TABLE gt_data
      WHERE objvers = 'A'.

  CATCH cx_sy_open_sql_db INTO DATA(lo_db_ex).
    WRITE: / 'Database error:', lo_db_ex->get_text( ).
    RETURN.

  CATCH cx_root INTO DATA(lo_ex).
    WRITE: / 'Error:', lo_ex->get_text( ).
    RETURN.
ENDTRY.
```

### File Operation Error Handling
```abap
CALL FUNCTION 'GUI_DOWNLOAD'
  EXPORTING
    filename              = p_path
    filetype              = 'ASC'
    codepage              = '4103'
    write_field_separator = space
  TABLES
    data_tab              = gt_csv
  EXCEPTIONS
    file_write_error      = 1
    no_batch              = 2
    gui_refuse_filetransfer = 3
    invalid_type          = 4
    no_authority          = 5
    unknown_error         = 6
    header_not_allowed    = 7
    separator_not_allowed = 8
    filesize_not_allowed  = 9
    header_too_long       = 10
    dp_error_create       = 11
    dp_error_send         = 12
    dp_error_write        = 13
    unknown_dp_error      = 14
    access_denied         = 15
    dp_out_of_memory      = 16
    disk_full             = 17
    dp_timeout            = 18
    file_not_found        = 19
    dataprovider_exception = 20
    control_flush_error   = 21
    OTHERS                = 22.

CASE sy-subrc.
  WHEN 0.
    WRITE: / 'File downloaded successfully:', p_path.
  WHEN 5.
    WRITE: / 'ERROR: No authorization for file download'.
  WHEN 15.
    WRITE: / 'ERROR: Access denied to path:', p_path.
  WHEN 17.
    WRITE: / 'ERROR: Disk full'.
  WHEN OTHERS.
    WRITE: / 'ERROR: Download failed. RC:', sy-subrc.
ENDCASE.
```

---

## CSV Export Patterns

### GUI Download (Dialog Mode)
```abap
FORM download_gui.
  DATA: lv_fullpath TYPE string.
  lv_fullpath = p_path.

  CALL FUNCTION 'GUI_DOWNLOAD'
    EXPORTING
      filename              = lv_fullpath
      filetype              = 'ASC'
      codepage              = '4103'  " UTF-8
      write_field_separator = space   " We handle separator
    TABLES
      data_tab              = gt_csv
    EXCEPTIONS
      OTHERS                = 99.

  IF sy-subrc <> 0.
    WRITE: / 'Error during GUI download. RC:', sy-subrc.
  ELSE.
    WRITE: / 'File downloaded to:', lv_fullpath.
  ENDIF.
ENDFORM.
```

### Application Server (Background Mode)
```abap
FORM download_server.
  DATA: lv_filename TYPE string.
  lv_filename = p_path.

  OPEN DATASET lv_filename FOR OUTPUT IN TEXT MODE ENCODING UTF-8.

  IF sy-subrc <> 0.
    WRITE: / 'Error opening file:', lv_filename.
    RETURN.
  ENDIF.

  LOOP AT gt_csv INTO gv_line.
    TRANSFER gv_line TO lv_filename.
  ENDLOOP.

  CLOSE DATASET lv_filename.
  WRITE: / 'File saved to server:', lv_filename.
ENDFORM.
```

### Automatic Mode Detection
```abap
FORM export_csv.
  " Build CSV lines first
  PERFORM build_csv_lines.

  " Choose export method based on execution mode
  IF sy-batch = abap_true.
    " Running in background - use app server
    PERFORM download_server.
  ELSEIF p_gui = abap_true.
    " GUI mode selected
    PERFORM download_gui.
  ELSE.
    " App server mode selected
    PERFORM download_server.
  ENDIF.
ENDFORM.
```

### CSV Line Builder
```abap
FORM build_csv_lines.
  DATA: lv_sep TYPE string.
  lv_sep = p_delim.

  " Header row
  IF p_head = abap_true.
    CLEAR gv_line.
    gv_line = 'FIELD1' && lv_sep &&
              'FIELD2' && lv_sep &&
              'FIELD3'.
    APPEND gv_line TO gt_csv.
  ENDIF.

  " Data rows
  LOOP AT gt_output INTO gs_output.
    CLEAR gv_line.
    gv_line = gs_output-field1 && lv_sep &&
              gs_output-field2 && lv_sep &&
              gs_output-field3.
    APPEND gv_line TO gt_csv.
    gv_count = gv_count + 1.
  ENDLOOP.
ENDFORM.
```

---

## Background Execution (SM37)

### Check Background Mode
```abap
IF sy-batch = abap_true.
  " Running in background
  " - No GUI_DOWNLOAD possible
  " - No SAPGUI_PROGRESS_INDICATOR
  " - Use WRITE for logging only
ELSE.
  " Running in dialog
  " - GUI_DOWNLOAD available
  " - Progress indicator works
ENDIF.
```

### Background-Compatible Logging
```abap
FORM log_message USING pv_type TYPE c
                       pv_text TYPE string.
  DATA: lv_timestamp TYPE string.

  " Format: YYYY-MM-DD HH:MM:SS
  lv_timestamp = |{ sy-datum DATE = ISO } { sy-uzeit TIME = ISO }|.

  CASE pv_type.
    WHEN 'I'.  " Info
      WRITE: / lv_timestamp, 'INFO:', pv_text.
    WHEN 'W'.  " Warning
      WRITE: / lv_timestamp, 'WARN:', pv_text.
    WHEN 'E'.  " Error
      WRITE: / lv_timestamp, 'ERROR:', pv_text.
    WHEN 'S'.  " Success
      WRITE: / lv_timestamp, 'SUCCESS:', pv_text.
  ENDCASE.
ENDFORM.

" Usage
PERFORM log_message USING 'I' 'Starting extraction'.
PERFORM log_message USING 'S' |Extracted { gv_count } records|.
```

### Job Scheduling Variant
Create variant via SE38 → Goto → Variants:
```
Variant: Z_DAILY_EXTRACT
- p_path: /usr/sap/trans/exports/daily_extract.csv
- p_gui: [unchecked]
- p_head: [checked]
- p_delim: ;
- s_date: Dynamic - Today minus 1 day to Today
```

---

## Debugging Tips

### Breakpoint in Development
```abap
" Conditional breakpoint
IF gs_output-iobjnm = '0MATERIAL'.
  BREAK-POINT.
ENDIF.

" Or use external breakpoint (SE38 → Utilities → Breakpoints)
```

### Debug Output
```abap
" For testing only - remove before production
IF sy-uname = 'DEVELOPER'.
  WRITE: / 'DEBUG: Row count:', lines( gt_data ).
  WRITE: / 'DEBUG: First record:', gs_data.
ENDIF.
```

### Spool Analysis (Background Jobs)
After SM37 job completion:
1. Double-click job to see details
2. Click "Spool" button
3. View WRITE output from program

---

## Common Errors and Solutions

### "No batch" Error
**Error**: `GUI_DOWNLOAD no_batch` exception
**Cause**: Program running in background, GUI not available
**Solution**: Use `sy-batch` check to route to app server export

### "Access denied" Error
**Error**: `GUI_DOWNLOAD access_denied` exception
**Cause**: Path doesn't exist or no write permission
**Solution**:
- Verify directory exists
- Check Windows folder permissions
- Try different path (e.g., C:\temp\)

### "Table not found" Error
**Error**: SQL error - table not found
**Cause**: Schema prefix in table name
**Solution**: Remove schema prefix (SAPABAP1.table → table)

### Empty Output File
**Error**: CSV file created but empty
**Cause**: No data returned from SELECT or FAE on empty table
**Solution**:
- Check WHERE filters
- Verify `objvers = 'A'` records exist
- Check FAE guard condition

### Encoding Issues
**Error**: Special characters display incorrectly
**Cause**: Wrong codepage
**Solution**: Use codepage 4103 (UTF-8) for GUI_DOWNLOAD

---

## Authorization Requirements

### Required Authorizations
| Auth Object | Field | Value | Description |
|-------------|-------|-------|-------------|
| S_TABU_DIS | DICBERCLS | * | Display authorization for tables |
| S_DATASET | ACTVT | 33 | Write to dataset |
| S_DATASET | FILENAME | * | File path pattern |
| S_GUI | ACTVT | 61 | GUI download |

### Check Authorization
```abap
AUTHORITY-CHECK OBJECT 'S_TABU_DIS'
  ID 'DICBERCLS' FIELD 'ROOSOURCE'
  ID 'ACTVT' FIELD '03'.

IF sy-subrc <> 0.
  WRITE: / 'ERROR: No authorization for table ROOSOURCE'.
  RETURN.
ENDIF.
```

---

## SE38 Execution Checklist

### Before Running
- [ ] Syntax check passes (Ctrl+F2)
- [ ] Program activated (Ctrl+F3)
- [ ] Output path is valid and writable
- [ ] Required authorizations are assigned
- [ ] Selection parameters set correctly

### During Execution
- [ ] Progress indicator advancing
- [ ] No short dumps (check SM21)
- [ ] Memory usage acceptable (SM50/SM66)

### After Execution
- [ ] Output file created at specified path
- [ ] Row count matches expectations
- [ ] CSV opens correctly in Excel
- [ ] Data types correct (dates, numbers)
- [ ] Encoding correct (special characters)

---

**Last Updated**: 2025-12-30
**Version**: 1.0
